#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Telegram åå­—æ›´æ–°å™¨ - ç®¡ç†å‘½ä»¤è¡Œå·¥å…·
ç”¨äºæ·»åŠ ã€åˆ é™¤ã€æŸ¥çœ‹è´¦å·
"""
import os
import sys
import json
import asyncio
import argparse
from datetime import datetime
from pathlib import Path

from telethon import TelegramClient
from telethon.errors import SessionPasswordNeededError, PhoneNumberInvalidError

# å…¨å±€å˜é‡
SESSIONS_DIR = Path('/app/data/sessions')
SESSIONS_DIR.mkdir(parents=True, exist_ok=True)
CONFIG_FILE = SESSIONS_DIR / 'config.json'


class ConfigManager:
    """é…ç½®ç®¡ç†å™¨"""
    
    def __init__(self):
        self.config_file = CONFIG_FILE
        self.config = self._load_config()
    
    def _load_config(self) -> dict:
        """åŠ è½½é…ç½®"""
        if self.config_file.exists():
            try:
                with open(self.config_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                print(f"âŒ åŠ è½½é…ç½®å¤±è´¥: {e}")
        return {'accounts': {}}
    
    def _save_config(self):
        """ä¿å­˜é…ç½®"""
        try:
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(self.config, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"âŒ ä¿å­˜é…ç½®å¤±è´¥: {e}")
    
    def add_account(self, phone: str, api_id: int, api_hash: str, name: str = "", username: str = ""):
        """æ·»åŠ è´¦å·"""
        self.config['accounts'][phone] = {
            'phone': phone,
            'api_id': api_id,
            'api_hash': api_hash,
            'name': name,
            'username': username,
            'added_at': datetime.now().isoformat()
        }
        self._save_config()
    
    def remove_account(self, phone: str):
        """åˆ é™¤è´¦å·"""
        if phone in self.config['accounts']:
            del self.config['accounts'][phone]
            self._save_config()
            # åˆ é™¤ session æ–‡ä»¶
            session_file = SESSIONS_DIR / f"{phone}.session"
            if session_file.exists():
                session_file.unlink()
    
    def get_account(self, phone: str):
        """è·å–è´¦å·ä¿¡æ¯"""
        return self.config['accounts'].get(phone)
    
    def get_all_accounts(self) -> dict:
        """è·å–æ‰€æœ‰è´¦å·"""
        return self.config['accounts']


config_manager = ConfigManager()


async def login_account():
    """ç™»å½•è´¦å·"""
    print("\n" + "="*60)
    print("ğŸ” æ·»åŠ æ–°è´¦å·")
    print("="*60)
    
    # æ­¥éª¤1: è·å– API å‡­è¯
    print("\nğŸ“‹ æ­¥éª¤ 1/3: API é…ç½®")
    print("ğŸ’¡ è®¿é—® https://my.telegram.org/apps è·å– API å‡­è¯")
    
    try:
        api_id = input("è¯·è¾“å…¥ API ID: ").strip()
        api_hash = input("è¯·è¾“å…¥ API Hash: ").strip()
        phone = input("è¯·è¾“å…¥æ‰‹æœºå· (æ ¼å¼: +86xxxxxxxxxx): ").strip()
        
        if not api_id or not api_hash or not phone:
            print("âŒ æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…å¡«çš„")
            return
        
        api_id = int(api_id)
        
        # åˆ›å»ºå®¢æˆ·ç«¯
        session_path = str(SESSIONS_DIR / phone)
        client = TelegramClient(session_path, api_id, api_hash)
        
        await client.connect()
        
        # æ­¥éª¤2: å‘é€éªŒè¯ç 
        print("\nğŸ“± æ­¥éª¤ 2/3: éªŒè¯ç éªŒè¯")
        print("â³ æ­£åœ¨å‘é€éªŒè¯ç ...")
        
        await client.send_code_request(phone)
        print("âœ… éªŒè¯ç å·²å‘é€åˆ°ä½ çš„ Telegram åº”ç”¨")
        
        code = input("è¯·è¾“å…¥éªŒè¯ç : ").strip()
        
        if not code:
            print("âŒ éªŒè¯ç ä¸èƒ½ä¸ºç©º")
            await client.disconnect()
            return
        
        try:
            # å°è¯•ç™»å½•
            await client.sign_in(phone, code)
            
        except SessionPasswordNeededError:
            # éœ€è¦ä¸¤æ­¥éªŒè¯
            print("\nğŸ”’ æ­¥éª¤ 3/3: ä¸¤æ­¥éªŒè¯")
            password = input("è¯·è¾“å…¥ä¸¤æ­¥éªŒè¯å¯†ç  (å¦‚æœªè®¾ç½®è¯·ç›´æ¥å›è½¦): ").strip()
            
            if password:
                await client.sign_in(password=password)
            else:
                print("âŒ éœ€è¦ä¸¤æ­¥éªŒè¯å¯†ç ")
                await client.disconnect()
                return
        
        # ç™»å½•æˆåŠŸï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
        me = await client.get_me()
        name = me.first_name or "Unknown"
        username = me.username or "unknown"
        
        print(f"\nâœ… ç™»å½•æˆåŠŸ!")
        print(f"ğŸ‘¤ ç”¨æˆ·: {name}")
        print(f"ğŸ“± ç”¨æˆ·å: @{username}")
        print(f"ğŸ“ æ‰‹æœºå·: {phone}")
        
        # ä¿å­˜é…ç½®
        config_manager.add_account(phone, api_id, api_hash, name, username)
        
        # æ–­å¼€è¿æ¥ï¼ˆå®ˆæŠ¤è¿›ç¨‹ä¼šè‡ªåŠ¨è¿æ¥ï¼‰
        await client.disconnect()
        
        print("\nğŸš€ è´¦å·å·²æ·»åŠ ï¼")
        print("ğŸ’¡ å®ˆæŠ¤è¿›ç¨‹ä¼šåœ¨å‡ ç§’å†…è‡ªåŠ¨å¯åŠ¨æ­¤è´¦å·")
        print("ğŸ’¡ ä½¿ç”¨ 'tg-cli list' æŸ¥çœ‹è´¦å·çŠ¶æ€")
        
    except PhoneNumberInvalidError:
        print("âŒ æ‰‹æœºå·æ ¼å¼é”™è¯¯")
    except Exception as e:
        print(f"âŒ ç™»å½•å¤±è´¥: {e}")


def list_accounts():
    """åˆ—å‡ºæ‰€æœ‰è´¦å·"""
    accounts = config_manager.get_all_accounts()
    
    if not accounts:
        print("\nğŸ“­ æš‚æ— è´¦å·")
        print("ğŸ’¡ ä½¿ç”¨ 'tg-cli add' æ·»åŠ è´¦å·")
        return
    
    print("\n" + "="*70)
    print(f"ğŸ“‹ è´¦å·åˆ—è¡¨ (å…± {len(accounts)} ä¸ª)")
    print("="*70)
    
    for i, (phone, data) in enumerate(accounts.items(), 1):
        name = data.get('name', 'Unknown')
        username = data.get('username', 'unknown')
        added_at = data.get('added_at', '')
        
        print(f"\n{i}. {name}")
        print(f"   ğŸ“± ç”¨æˆ·å: @{username}")
        print(f"   ğŸ“ æ‰‹æœºå·: {phone}")
        print(f"   ğŸ“… æ·»åŠ æ—¶é—´: {added_at[:10] if added_at else 'æœªçŸ¥'}")
    
    print("\n" + "="*70)
    print("ğŸ’¡ æ‰€æœ‰è´¦å·ç”±å®ˆæŠ¤è¿›ç¨‹è‡ªåŠ¨ç®¡ç†")
    print("ğŸ’¡ ä½¿ç”¨ 'docker logs -f tgtime' æŸ¥çœ‹è¿è¡Œæ—¥å¿—")


async def delete_account(phone: str):
    """åˆ é™¤è´¦å·"""
    account = config_manager.get_account(phone)
    if not account:
        print(f"âŒ è´¦å·ä¸å­˜åœ¨: {phone}")
        return
    
    name = account.get('name', 'Unknown')
    print(f"\nâš ï¸  å³å°†åˆ é™¤è´¦å·: {name} ({phone})")
    confirm = input("ç¡®å®šè¦åˆ é™¤å—? (yes/no): ").strip().lower()
    
    if confirm not in ['yes', 'y']:
        print("âŒ å·²å–æ¶ˆ")
        return
    
    # åˆ é™¤é…ç½®
    config_manager.remove_account(phone)
    
    print(f"âœ… å·²åˆ é™¤è´¦å·: {phone}")
    print("ğŸ’¡ å®ˆæŠ¤è¿›ç¨‹ä¼šåœ¨å‡ ç§’å†…è‡ªåŠ¨åœæ­¢æ­¤è´¦å·")


def show_status():
    """æ˜¾ç¤ºå®ˆæŠ¤è¿›ç¨‹çŠ¶æ€"""
    pid_file = Path('/app/data/daemon.pid')
    log_file = Path('/app/data/daemon.log')
    
    print("\n" + "="*60)
    print("ğŸ“Š ç³»ç»ŸçŠ¶æ€")
    print("="*60)
    
    # æ£€æŸ¥å®ˆæŠ¤è¿›ç¨‹
    if pid_file.exists():
        with open(pid_file, 'r') as f:
            pid = f.read().strip()
        print(f"âœ… å®ˆæŠ¤è¿›ç¨‹è¿è¡Œä¸­ (PID: {pid})")
    else:
        print("âŒ å®ˆæŠ¤è¿›ç¨‹æœªè¿è¡Œ")
    
    # è´¦å·ç»Ÿè®¡
    accounts = config_manager.get_all_accounts()
    print(f"ğŸ“± å·²é…ç½®è´¦å·: {len(accounts)} ä¸ª")
    
    # æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—
    if log_file.exists():
        print("\nğŸ“ æœ€è¿‘æ—¥å¿— (æœ€å10è¡Œ):")
        print("-" * 60)
        try:
            with open(log_file, 'r') as f:
                lines = f.readlines()
                for line in lines[-10:]:
                    print(line.rstrip())
        except Exception as e:
            print(f"è¯»å–æ—¥å¿—å¤±è´¥: {e}")
    
    print("="*60)
    print("ğŸ’¡ ä½¿ç”¨ 'docker logs -f tgtime' æŸ¥çœ‹å®æ—¶æ—¥å¿—")


def print_help():
    """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
    help_text = """
ğŸ¤– Telegram åå­—è‡ªåŠ¨æ›´æ–° - ç®¡ç†å·¥å…·

ğŸ“– ä½¿ç”¨æ–¹æ³•:
    tg-cli add           æ·»åŠ æ–°è´¦å·ï¼ˆç™»å½•ï¼‰
    tg-cli list          æŸ¥çœ‹æ‰€æœ‰è´¦å·
    tg-cli delete PHONE  åˆ é™¤æŒ‡å®šè´¦å·
    tg-cli status        æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
    tg-cli help          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ğŸ“ ç¤ºä¾‹:
    tg-cli add                    # äº¤äº’å¼æ·»åŠ è´¦å·
    tg-cli list                   # æŸ¥çœ‹è´¦å·åˆ—è¡¨
    tg-cli delete +8613800138000  # åˆ é™¤æŒ‡å®šè´¦å·
    tg-cli status                 # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€

ğŸ’¡ æç¤º:
    - æ·»åŠ è´¦å·åä¼šè‡ªåŠ¨å¼€å§‹æ›´æ–°åå­—
    - å®ˆæŠ¤è¿›ç¨‹åœ¨åå°æŒç»­è¿è¡Œ
    - å®¹å™¨é‡å¯åè‡ªåŠ¨æ¢å¤æ‰€æœ‰è´¦å·
    - ä½¿ç”¨ 'docker logs -f tgtime' æŸ¥çœ‹å®æ—¶æ—¥å¿—
"""
    print(help_text)


async def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description='Telegram åå­—è‡ªåŠ¨æ›´æ–°ç®¡ç†å·¥å…·',
        add_help=False
    )
    parser.add_argument('command', nargs='?', help='å‘½ä»¤: add/list/delete/status/help')
    parser.add_argument('args', nargs='*', help='å‘½ä»¤å‚æ•°')
    
    args = parser.parse_args()
    
    if not args.command or args.command == 'help':
        print_help()
    
    elif args.command == 'add':
        await login_account()
    
    elif args.command == 'list':
        list_accounts()
    
    elif args.command == 'delete':
        if not args.args:
            print("âŒ è¯·æŒ‡å®šè¦åˆ é™¤çš„æ‰‹æœºå·")
            print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•: tg-cli delete +8613800138000")
        else:
            await delete_account(args.args[0])
    
    elif args.command == 'status':
        show_status()
    
    else:
        print(f"âŒ æœªçŸ¥å‘½ä»¤: {args.command}")
        print("ğŸ’¡ ä½¿ç”¨ 'tg-cli help' æŸ¥çœ‹å¸®åŠ©")


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nâš ï¸  å·²å–æ¶ˆ")
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        sys.exit(1)